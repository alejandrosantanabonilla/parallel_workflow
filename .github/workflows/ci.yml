name: "Parallel MPI CI/CD"

# This workflow is triggered on any push or pull request to the 'main' branch.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-parallel-execution:
    # A descriptive name for the job that will appear in the GitHub Actions UI.
    name: "Run Parallel Integration Test"
    
    # The job will run on a virtual machine with the latest version of Ubuntu.
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get the code from your repository.
      - name: "Checkout repository code"
        uses: actions/checkout@v4

      # Step 2: Set up a specific version of Python.
      - name: "Set up Python 3.9"
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # Step 3: Install the required system-level MPI library (OpenMPI).
      - name: "Install system-level MPI"
        run: |
          sudo apt-get update
          sudo apt-get install -y openmpi-bin libopenmpi-dev

      # Step 4: Install the Python dependencies including pytest.
      - name: "Install Python package and test dependencies"
        run: |
          # Install the testing frameworks first
          pip install pytest pytest-mpi

          # Install the core package in editable mode.
          pip install -e .
          
          # Force mpi4py to be compiled from source.
          pip install --no-binary :all: mpi4py
          
          # Now that mpi4py is correctly installed, install dask-mpi.
          pip install dask-mpi
      
      # Step 5: Execute the parallel tests using pytest.
      # The pytest-mpi plugin allows pytest to run tests in parallel via mpirun.
      # We explicitly point it to the 'tests/' directory, which contains the test data.
      - name: "Run parallel integration test with pytest"
        run: |
          echo "Executing tests within the 'tests/' directory with 4 parallel MPI processes..."
          mpirun --oversubscribe -n 4 python -m pytest --with-mpi mpi tests/        



